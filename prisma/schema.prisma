generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. สินค้า (Product)
model Product {
  id            Int      @id @default(autoincrement()) @db.UnsignedInt
  category_id   Int      @db.UnsignedInt
  name          String   @unique(map: "uq_product_name") @db.VarChar(200)
  unit_id       Int      @db.UnsignedInt
  unit_price    Decimal  @default(0.00) @db.Decimal(12, 2)
  safety_stock  Decimal  @default(0.00) @db.Decimal(12, 2)
  current_stock Decimal  @default(0.00) @db.Decimal(12, 2)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.DateTime(0)
  updated_at    DateTime @default(now()) @db.DateTime(0)

  // Relation Fields (แก้ Type ให้ตรงกับชื่อ Model ด้านล่าง)
  category      Category  @relation(fields: [category_id], references: [id], map: "fk_prod_category")
  unit          Unit      @relation(fields: [unit_id], references: [id], map: "fk_prod_unit")
  
  stock_in      StockIn[]
  stock_out     StockOut[]
  movements     StockMovement[]

  @@map("products") // ชื่อตารางจริงใน DB
}

// 2. หมวดหมู่ (Category)
model Category {
  id         Int       @id @default(autoincrement()) @db.UnsignedInt
  name       String    @unique(map: "uq_category_name") @db.VarChar(100)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.DateTime(0)
  updated_at DateTime  @default(now()) @db.DateTime(0)
  
  products   Product[] // Link กลับไปหา Product

  @@map("categories")
}

// 3. หน่วยนับ (Unit)
model Unit {
  id         Int       @id @default(autoincrement()) @db.UnsignedInt
  name       String    @unique(map: "uq_unit_name") @db.VarChar(50)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.DateTime(0)
  //updated_at DateTime  @default(now()) @db.DateTime(0)

  products   Product[]

  @@map("units")
}

// 4. รับเข้า (StockIn)
model StockIn {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  product_id  Int      @db.UnsignedInt
  quantity    Decimal  @db.Decimal(12, 2)
  stock_date  DateTime @db.Date
  stock_time  DateTime? @db.Time(0)
  officer_id  Int?     @db.UnsignedInt
  remark      String?  @db.Text
  created_at  DateTime @default(now()) @db.DateTime(0)

  product     Product   @relation(fields: [product_id], references: [id], map: "fk_si_product")
  officer     Employee? @relation(fields: [officer_id], references: [id], map: "fk_si_officer")

  @@map("stock_in")
}

// 5. เบิกออก (StockOut)
model StockOut {
  id              Int       @id @default(autoincrement()) @db.UnsignedInt
  product_id      Int       @db.UnsignedInt
  department_id   Int?      @db.UnsignedInt
  quantity        Decimal   @db.Decimal(12, 2)
  stock_before    Decimal?  @db.Decimal(12, 2)
  withdrawal_date DateTime  @db.Date
  withdrawal_time DateTime? @db.Time(0)
  requester_id    Int?      @db.UnsignedInt
  officer_id      Int?      @db.UnsignedInt
  status          String    @default("pending") @db.VarChar(20)
  created_at      DateTime  @default(now()) @db.DateTime(0)

  product         Product     @relation(fields: [product_id], references: [id], map: "fk_so_product")
  department      Department? @relation(fields: [department_id], references: [id], map: "fk_so_dept")
  requester       Employee?   @relation("Requester", fields: [requester_id], references: [id], map: "fk_so_requester")
  officer         Employee?   @relation("Officer", fields: [officer_id], references: [id], map: "fk_so_officer")

  @@map("stock_out")
}

// 6. พนักงาน (Employee)
model Employee {
  id        Int     @id @default(autoincrement()) @db.UnsignedInt
  full_name String  @db.VarChar(100) 
  nickname  String? @db.VarChar(100)

  username  String? @unique @db.VarChar(50) 
  password  String? @db.VarChar(255)
  role      String  @default("staff") @db.VarChar(20)
  stock_in        StockIn[]
  requested_outs  StockOut[] @relation("Requester")
  approved_outs   StockOut[] @relation("Officer")
  movements       StockMovement[]

  @@map("employees")
}

// 7. แผนก (Department)
model Department {
  id    Int    @id @default(autoincrement()) @db.UnsignedInt
  name  String @unique @db.VarChar(100)
  
  stock_outs StockOut[]

  @@map("departments")
}

// 8. ความเคลื่อนไหว (StockMovement)
model StockMovement {
  id             Int       @id @default(autoincrement()) @db.UnsignedInt
  product_id     Int       @db.UnsignedInt
  movement_type  String    @db.VarChar(20)
  reference_type String    @db.VarChar(50)
  reference_id   Int       @db.UnsignedInt
  quantity       Decimal   @db.Decimal(12, 2)
  stock_before   Decimal   @db.Decimal(12, 2)
  stock_after    Decimal   @db.Decimal(12, 2)
  movement_date  DateTime  @db.Date
  movement_time  DateTime? @db.Time(0)
  performed_by   Int?      @db.UnsignedInt
  remark         String?   @db.Text
  created_at     DateTime  @default(now()) @db.DateTime(0)

  product        Product   @relation(fields: [product_id], references: [id], map: "fk_sm_product")
  actor          Employee? @relation(fields: [performed_by], references: [id], map: "fk_sm_actor")

  @@map("stock_movements")
}